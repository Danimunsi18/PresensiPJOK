
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Presensi Multi-Login SDN Dukuhwringin 02</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6 font-sans">

<!-- Login -->
<div id="login-section" class="max-w-sm mx-auto bg-white p-6 rounded-xl shadow-md">
  <h2 class="text-xl font-bold mb-4">Login Guru</h2>
  <input type="text" id="username" placeholder="Username" class="w-full mb-3 p-2 border rounded" />
  <input type="password" id="password" placeholder="Password" class="w-full mb-3 p-2 border rounded" />
  <button onclick="login()" class="bg-blue-500 text-white px-4 py-2 rounded w-full">Login</button>
  <p id="login-error" class="text-red-500 mt-2 hidden">Username atau password salah!</p>
</div>

<!-- Dashboard -->
<div id="app-section" class="hidden">
  <h1 class="text-2xl font-bold mb-2 text-center">Presensi SD Negeri Dukuhwringin 02</h1>
  <p class="text-center mb-4">Guru: <span id="guru-nama" class="font-semibold"></span></p>

  <div class="flex flex-wrap gap-2 mb-4">
    <label>Kelas:
      <select id="kelas" class="border p-2 rounded">
        <option value="">Pilih Kelas</option>
        <option value="1">Kelas 1</option>
        <option value="2">Kelas 2</option>
        <option value="3">Kelas 3</option>
        <option value="4">Kelas 4</option>
        <option value="5">Kelas 5</option>
        <option value="6">Kelas 6</option>
      </select>
    </label>
    <input type="date" id="tanggal" class="border p-2 rounded" />
    <input type="file" id="fileExcel" accept=".xlsx" class="p-2" />
    <button onclick="exportExcel()" class="bg-green-600 text-white px-4 py-2 rounded">Unduh Excel</button>
  </div>

  <div id="siswa-container" class="overflow-x-auto mt-4"></div>
  <button onclick="kirimPresensi()" class="bg-blue-600 text-white px-6 py-2 mt-4 rounded">Simpan Presensi</button>

  <hr class="my-6"/>

  <h2 class="text-xl font-bold mb-2">Riwayat Presensi</h2>
  <button onclick="loadRiwayat()" class="bg-gray-700 text-white px-4 py-2 rounded">Muat Riwayat</button>
  <div id="riwayat-container" class="overflow-x-auto mt-4"></div>
</div>

<script>
let currentGuru = null;
let siswaData = [];

const users = {
  "admin": { password: "admin18", nama: "Admin" },
  "budi": { password: "budi123", nama: "Budi" },
  "niken": { password: "niken123", nama: "Niken" }
};

function login() {
  const u = document.getElementById("username").value.toLowerCase();
  const p = document.getElementById("password").value;
  if (users[u] && users[u].password === p) {
    currentGuru = users[u].nama;
    document.getElementById("login-section").style.display = "none";
    document.getElementById("app-section").style.display = "block";
    document.getElementById("guru-nama").innerText = currentGuru;
  } else {
    document.getElementById("login-error").classList.remove("hidden");
  }
}

document.getElementById('fileExcel').addEventListener('change', function(e) {
  const reader = new FileReader();
  reader.onload = function(event) {
    const data = new Uint8Array(event.target.result);
    const workbook = XLSX.read(data, {type: 'array'});
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(sheet);
    siswaData = json;
    tampilkanSiswa();
  };
  reader.readAsArrayBuffer(e.target.files[0]);
});

function tampilkanSiswa() {
  const container = document.getElementById("siswa-container");
  if (siswaData.length === 0) {
    container.innerHTML = "<p class='text-red-500'>Data siswa belum dimuat.</p>";
    return;
  }

  let html = "<table class='min-w-full bg-white border'><thead><tr class='bg-gray-200'>";
  html += "<th class='border px-4 py-2'>No</th><th class='border px-4 py-2'>Nama</th><th class='border px-4 py-2'>Presensi</th></tr></thead><tbody>";

  siswaData.forEach((siswa, i) => {
    html += `<tr>
      <td class='border px-4 py-2'>${i + 1}</td>
      <td class='border px-4 py-2'>${siswa["Nama Murid"] || ""}</td>
      <td class='border px-4 py-2'>
        <select id="presensi-${i}" class="border rounded p-1">
          <option value="Hadir">Hadir</option>
          <option value="Izin">Izin</option>
          <option value="Sakit">Sakit</option>
          <option value="Alpha">Alpha</option>
        </select>
      </td>
    </tr>`;
  });

  html += "</tbody></table>";
  container.innerHTML = html;
}

function kirimPresensi() {
  const tanggal = document.getElementById("tanggal").value;
  const kelas = document.getElementById("kelas").value;
  if (!tanggal || !kelas) return alert("Tanggal dan kelas wajib diisi!");

  const data = siswaData.map((s, i) => ({
    tanggal,
    kelas,
    nama: s["Nama Murid"],
    status: document.getElementById(`presensi-${i}`).value,
    guru: currentGuru
  }));

  fetch("https://script.google.com/macros/s/AKfycbw7ML07b2L8r9_vqmswcGaNmGfwgY1xjLbiDndOxlkLJx-55apk7eZlI7YhO2mvIRyNzA/exec", {
    method: "POST",
    body: JSON.stringify(data),
    headers: { "Content-Type": "application/json" }
  }).then(res => {
    if (res.ok) alert("Presensi berhasil disimpan!");
    else alert("Gagal menyimpan presensi.");
  });
}

function exportExcel() {
  const wb = XLSX.utils.book_new();
  const data = siswaData.map((s, i) => ({
    "No": i + 1,
    "Nama": s["Nama Murid"],
    "Presensi": document.getElementById(`presensi-${i}`)?.value || ""
  }));
  const ws = XLSX.utils.json_to_sheet(data);
  XLSX.utils.book_append_sheet(wb, ws, "Presensi");
  XLSX.writeFile(wb, "Presensi_Siswa.xlsx");
}

function loadRiwayat() {
  fetch("https://script.google.com/macros/s/AKfycbw7ML07b2L8r9_vqmswcGaNmGfwgY1xjLbiDndOxlkLJx-55apk7eZlI7YhO2mvIRyNzA/exec")
    .then(res => res.json())
    .then(rows => {
      let html = "<table class='min-w-full bg-white border'><thead><tr class='bg-gray-200'>";
      html += "<th class='border px-4 py-2'>Tanggal</th><th class='border px-4 py-2'>Kelas</th><th class='border px-4 py-2'>Nama</th><th class='border px-4 py-2'>Status</th><th class='border px-4 py-2'>Guru</th></tr></thead><tbody>";
      rows.forEach(r => {
        html += `<tr>
          <td class='border px-2 py-1'>${r.tanggal}</td>
          <td class='border px-2 py-1'>${r.kelas}</td>
          <td class='border px-2 py-1'>${r.nama}</td>
          <td class='border px-2 py-1'>${r.status}</td>
          <td class='border px-2 py-1'>${r.guru}</td>
        </tr>`;
      });
      html += "</tbody></table>";
      document.getElementById("riwayat-container").innerHTML = html;
    });
}
</script>


<hr class="my-6">
<h2 class="text-xl font-semibold mb-4">ðŸ“Š Rekap dan Statistik Kehadiran</h2>
<div class="flex flex-wrap items-center gap-4 mb-4">
    <input type="date" id="filterTanggal" class="border p-2 rounded" />
    <select id="filterKelas" class="border p-2 rounded">
        <option value="">Semua Kelas</option>
        <option value="1">Kelas 1</option>
        <option value="2">Kelas 2</option>
        <option value="3">Kelas 3</option>
        <option value="4">Kelas 4</option>
        <option value="5">Kelas 5</option>
        <option value="6">Kelas 6</option>
    </select>
    <button onclick="filterData()" class="bg-green-600 text-white px-4 py-2 rounded">Terapkan Filter</button>
    <button onclick="cetakRekap()" class="bg-orange-500 text-white px-4 py-2 rounded">Cetak Rekap</button>
</div>
<div id="statistikPresensi" class="bg-gray-100 p-4 rounded shadow"></div>
<div id="rekapTabel" class="overflow-x-auto mt-4"></div>

<script>
function filterData() {
    const tanggal = document.getElementById("filterTanggal").value;
    const kelas = document.getElementById("filterKelas").value;
    fetch(historyUrl)
        .then((res) => res.json())
        .then((data) => {
            const filtered = data.filter((row) => {
                const matchTanggal = !tanggal || row.tanggal === tanggal;
                const matchKelas = !kelas || row.kelas === kelas;
                return matchTanggal && matchKelas;
            });

            let html = '<table class="min-w-full border"><thead><tr class="bg-blue-100"><th class="border px-2 py-1">No</th><th class="border px-2 py-1">Nama</th><th class="border px-2 py-1">Status</th></tr></thead><tbody>';
            let hadir = 0, sakit = 0, izin = 0, alpha = 0;

            filtered.forEach((row, i) => {
                html += `<tr><td class="border px-2 py-1">${i + 1}</td><td class="border px-2 py-1">${row.nama}</td><td class="border px-2 py-1">${row.status}</td></tr>`;
                if (row.status === "Hadir") hadir++;
                if (row.status === "Sakit") sakit++;
                if (row.status === "Izin") izin++;
                if (row.status === "Alpha") alpha++;
            });

            html += "</tbody></table>";
            document.getElementById("rekapTabel").innerHTML = html;

            const statistik = `
                <p><strong>Total Data:</strong> ${filtered.length}</p>
                <p><strong>Hadir:</strong> ${hadir}</p>
                <p><strong>Sakit:</strong> ${sakit}</p>
                <p><strong>Izin:</strong> ${izin}</p>
                <p><strong>Alpha:</strong> ${alpha}</p>
            `;
            document.getElementById("statistikPresensi").innerHTML = statistik;
        });
}

function cetakRekap() {
    const printContent = document.getElementById("rekapTabel").innerHTML;
    const newWin = window.open("", "", "width=900,height=600");
    newWin.document.write("<html><head><title>Cetak Rekap Presensi</title>");
    newWin.document.write('<style>table { width: 100%; border-collapse: collapse; } td, th { border: 1px solid #000; padding: 6px; }</style>');
    newWin.document.write("</head><body>");
    newWin.document.write("<h2>Rekap Presensi</h2>");
    newWin.document.write(printContent);
    newWin.document.write("</body></html>");
    newWin.document.close();
    newWin.print();
}
</script>
</body>
</html>
